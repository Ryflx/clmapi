<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Status - Docusign CLM Portal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Back Navigation -->
        <div class="back-nav">
            <a href="index.html" class="back-btn">‚Üê Back to Portal</a>
        </div>

        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 30px;">
                <div>
                    <h1>Workflow Status Tracking</h1>
                </div>
                <button id="refreshStatuses" class="task-btn primary">Refresh Status</button>
            </div>
        </header>
        
        <!-- Page Description -->
        <div style="margin-bottom: 20px; padding: 0 30px;">
            <p style="color: #666; margin: 0; font-size: 1.1rem; padding: 0 10px;">Monitor all active workflows and their real-time status updates</p>
        </div>

        <!-- Summary Cards -->
        <div class="status-summary">
            <div class="summary-card">
                <h3 id="totalWorkflows">0</h3>
                <p>Total Workflows</p>
            </div>
            <div class="summary-card running">
                <h3 id="runningWorkflows">0</h3>
                <p>Running</p>
            </div>
            <div class="summary-card completed">
                <h3 id="completedWorkflows">0</h3>
                <p>Completed</p>
            </div>
            <div class="summary-card failed">
                <h3 id="failedWorkflows">0</h3>
                <p>Failed</p>
            </div>
        </div>

        <!-- Workflow Status Table -->
        <div class="form-section">
            <div class="form-section-header">
                <h3>Workflow Status History</h3>
                <div class="workflow-actions">
                    <button id="clearOldStatuses" class="task-btn secondary">Clear Old Statuses</button>
                    <button id="exportStatuses" class="task-btn secondary">Export CSV</button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="status-display" style="display: none;">
                <strong>Loading workflow statuses...</strong>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="status-display" style="display: block;">
                <strong>No workflow statuses yet</strong>
                <p>Workflow status updates will appear here when workflows are submitted and call back to the status API.</p>
                <div class="api-info">
                    <h4>API Endpoint for CLM Workflows:</h4>
                    <code>POST /api/workflow-status</code>
                    <pre>{
  "workflowId": "your-workflow-id",
  "workflowName": "Service Agreement - API",
  "status": "running|completed|failed",
  "message": "Optional status message",
  "timestamp": "2025-01-28T10:30:00Z"
}</pre>
                </div>
            </div>

            <!-- Status Table -->
            <div id="statusTable" style="display: none;">
                <table class="workflow-table">
                    <thead>
                        <tr>
                            <th>Workflow ID</th>
                            <th>Workflow Name</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Message</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody">
                        <!-- Status rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let workflowStatuses = [];

        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            loadWorkflowStatuses();
            
            // Set up refresh
            document.getElementById('refreshStatuses').addEventListener('click', loadWorkflowStatuses);
            
            // Set up clear old statuses
            document.getElementById('clearOldStatuses').addEventListener('click', clearOldStatuses);
            
            // Set up export
            document.getElementById('exportStatuses').addEventListener('click', exportStatusesToCSV);
            
            // Set up auto-refresh every 10 seconds
            setInterval(loadWorkflowStatuses, 10000);
        });

        async function loadWorkflowStatuses() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/workflow-status');
                if (response.ok) {
                    workflowStatuses = await response.json();
                    displayWorkflowStatuses();
                    updateSummary();
                } else {
                    console.error('Failed to load workflow statuses:', response.status);
                    workflowStatuses = [];
                    displayWorkflowStatuses();
                    updateSummary();
                }
            } catch (error) {
                console.error('Error loading workflow statuses:', error);
                workflowStatuses = [];
                displayWorkflowStatuses();
                updateSummary();
            } finally {
                showLoading(false);
            }
        }

        function displayWorkflowStatuses() {
            const emptyState = document.getElementById('emptyState');
            const statusTable = document.getElementById('statusTable');
            const tableBody = document.getElementById('statusTableBody');

            if (workflowStatuses.length === 0) {
                emptyState.style.display = 'block';
                statusTable.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            statusTable.style.display = 'block';

            // Sort by timestamp (newest first)
            workflowStatuses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            tableBody.innerHTML = workflowStatuses.map(status => `
                <tr class="status-row ${status.status}">
                    <td class="workflow-id">
                        <code>${status.workflowId}</code>
                    </td>
                    <td class="workflow-name-cell">
                        ${escapeHtml(status.workflowName || 'Unknown Workflow')}
                    </td>
                    <td class="status-cell">
                        <span class="workflow-status ${status.status}">
                            ${status.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="timestamp-cell">
                        ${formatTimestamp(status.timestamp)}
                    </td>
                    <td class="message-cell">
                        ${escapeHtml(status.message || 'No message')}
                    </td>
                    <td class="actions-cell">
                        <button class="task-btn small" onclick="deleteStatus('${status.workflowId}')">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSummary() {
            const total = workflowStatuses.length;
            const running = workflowStatuses.filter(s => s.status === 'running').length;
            const completed = workflowStatuses.filter(s => s.status === 'completed').length;
            const failed = workflowStatuses.filter(s => s.status === 'failed').length;

            document.getElementById('totalWorkflows').textContent = total;
            document.getElementById('runningWorkflows').textContent = running;
            document.getElementById('completedWorkflows').textContent = completed;
            document.getElementById('failedWorkflows').textContent = failed;
        }

        async function deleteStatus(workflowId) {
            if (!confirm('Are you sure you want to delete this workflow status?')) return;

            try {
                const response = await fetch(`/api/workflow-status/${workflowId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadWorkflowStatuses(); // Refresh the list
                } else {
                    alert('Failed to delete workflow status');
                }
            } catch (error) {
                console.error('Error deleting status:', error);
                alert('Error deleting workflow status');
            }
        }

        async function clearOldStatuses() {
            if (!confirm('Are you sure you want to clear all completed and failed workflows older than 24 hours?')) return;

            try {
                const response = await fetch('/api/workflow-status/cleanup', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadWorkflowStatuses(); // Refresh the list
                    alert('Old statuses cleared successfully');
                } else {
                    alert('Failed to clear old statuses');
                }
            } catch (error) {
                console.error('Error clearing statuses:', error);
                alert('Error clearing old statuses');
            }
        }

        function exportStatusesToCSV() {
            if (workflowStatuses.length === 0) {
                alert('No data to export');
                return;
            }

            const csvHeader = 'Workflow ID,Workflow Name,Status,Timestamp,Message\n';
            const csvData = workflowStatuses.map(status => 
                `"${status.workflowId}","${escapeCSV(status.workflowName || '')}","${status.status}","${status.timestamp}","${escapeCSV(status.message || '')}"`
            ).join('\n');

            const csvContent = csvHeader + csvData;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `workflow-statuses-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch {
                return timestamp;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeCSV(text) {
            if (!text) return '';
            return text.replace(/"/g, '""');
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
